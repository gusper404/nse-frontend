---
import qs from 'qs';
import Cards from '../../components/Cards.astro';
import Card from '../../components/Card.astro';
import Filter from '../../components/Filter.jsx';
import RadioLayout from '../../layouts/RadioLayout.astro';
import youtubeThumbnail from 'youtube-thumbnail';
 
const currentUrl = Astro.url;
const path = Astro.url.pathname;
const title = 'NSE Radio - Nuestra Se√±ora del Encuentro con Dios';
const endpoint = 'radios';

const query = qs.stringify({
    fields: ['title', 'slug'],
    populate: {
      videos: '*',
      category: {
        fields: ['name',  'slug']
      }
    },
		sort: 'createdAt:DESC'
  }, {
    encodeValuesOnly: true
  })

const response = await fetch(`${import.meta.env.PUBLIC_STRAPI_API_URL}/${endpoint}?${query}`);
const { data:posts } = await response.json();
---

<RadioLayout title={title}>

	<div class="space-y-4">
		<Filter data={posts} path={path} endpoint={endpoint} currentUrl={currentUrl} currentCategory='' client:load/>
	
		<Cards>
			{posts.map(({attributes:post}) => {
					const { high } = youtubeThumbnail(post.videos[0].url);
					const options = {
						url: post.videos.length > 1 ? path + '/' + post.slug : post.videos[0].url,
						target: post.videos.length > 1 ? '_self' : '_blank'
					}
					return (
						<Card 
							key={post.id}
							title={post.title} 
							image={high.url}
							imgw={high.width}
							imgh={high.height}
							{...options}
							icon={post.type}
						/>
					)
				}
			)}
		</Cards>
	</div>

</RadioLayout>